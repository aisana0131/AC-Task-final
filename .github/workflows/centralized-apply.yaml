name: Centralized Terraform Workflow

on:
  workflow_call:
    inputs:
      working_directory:
        required: true
        type: string
      aws_role_arn:
        required: true
        type: string
      s3_bucket:
        required: true
        type: string
      s3_key_prefix:
        required: true
        type: string
      aws_region:
        required: true
        type: string
    secrets:
      AWS_ACCOUNT_ID:    
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.14.0

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ inputs.working_directory }}
        continue-on-error: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ inputs.working_directory }}
        continue-on-error: true

 
  tfplan:
    needs: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.14.0

      - name: Terraform Init
        run: terraform -chdir="${{ inputs.working_directory }}" init

      - name: Terraform Validate
        run: terraform -chdir="${{ inputs.working_directory }}" validate

      - name: Terraform Plan
        run: terraform -chdir="${{ inputs.working_directory }}" plan -out=tfplan

      - name: Upload plan to S3
        run: aws s3 cp ${{ inputs.working_directory }}/tfplan s3://${{ inputs.s3_bucket }}/${{ inputs.s3_key_prefix }}/tfplan

  apply:
    needs: tfplan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws_role_arn }}
          aws-region: ${{ inputs.aws_region }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.14.0

      - name: Terraform Init
        run: terraform -chdir="${{ inputs.working_directory }}" init

      - name: Download plan from S3
        run: aws s3 cp s3://${{ inputs.s3_bucket }}/${{ inputs.s3_key_prefix }}/tfplan ${{ inputs.working_directory }}/tfplan

      - name: Terraform Apply
        run: terraform -chdir="${{ inputs.working_directory }}" apply -auto-approve tfplan